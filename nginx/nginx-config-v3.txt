#日志
access_log logs/access.log access;
error_log logs/error.log;

log_format access '$HTTP_X_REAL_IP - $remote_user [$time_local] "$request" '
'$status $body_bytes_sent "$http_referer" '
'"$http_user_agent" $HTTP_X_Forwarded_For';


#gzip 压缩传输
gzip on;
gzip_min_length 1k;  #最小1K
gzip_buffers 16 64K;
gzip_http_version 1.1;
gzip_comp_level 6;
gzip_types text/plain application/x-javascript text/css application/xml application/javascript;
gzip_vary on;

#缓冲区代理缓冲用户端请求的最大字节数,可以理解为保存到本地再传给用户
client_header_buffer_size    1k;
large_client_header_buffers  4 4k;
client_max_body_size 50m;
client_body_buffer_size 256k;
client_header_timeout 3m;
client_body_timeout 3m;
send_timeout 3m;

#负载均衡组
#静态服务器组
upstream static.zh-jieli.com {
    server 127.0.0.1:808 weight=1;
}
#动态服务器组
upstream zh-jieli.com {
    server 127.0.0.1:8080;
    #server 192.168.8.203:8080;
}

#配置代理参数
proxy_connect_timeout 300s;
proxy_send_timeout 300s;
proxy_read_timeout 300s;
proxy_buffer_size 64k;
proxy_buffers 4 32k;
proxy_busy_buffers_size 64k;

#缓存配置
proxy_cache_key '$host:$server_port$request_uri';
proxy_temp_file_write_size 64k;
proxy_temp_path /dev/shm/JieLiERP/proxy_temp_path;
proxy_cache_path /dev/shm/JieLiERP/proxy_cache_path levels=1:2 keys_zone=cache_one:200m inactive=5d max_size=1g;
proxy_ignore_headers X-Accel-Expires Expires Cache-Control Set-Cookie;
proxy_ignore_client_abort on; #不允许代理端主动关闭连接

server
{
    listen 80;
    server_name xxx123.tk;
    location / {
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://192.168.10.38:3000;
    }
    access_log logs/xxx123.tk_access.log;
}

location ~ .*.(images|javascript|flash|media|static|js|css|ico|png|jpg|eot|svg|ttf|woff) {
    proxy_cache cache_one;
    proxy_cache_valid 200 304 302 5d;
    proxy_cache_valid any 5d;
    proxy_cache_key '$host:$server_port$request_uri';
    add_header X-Cache '$upstream_cache_status from $host';
    proxy_pass http://192.168.8.203:808;
    expires 30d; #缓存30天
}
